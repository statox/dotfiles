#!/usr/bin/env bash

# A simple timer script. This is not meant to be precise to the ms, just
# to give a rough estimate of elapsed time.
#
# Stop it with ctrl+c or `kill {PID}` to get the total run time

format_seconds() {
    local total_seconds=$1
    local hours=$(( total_seconds / 3600 ))
    local minutes=$(( (total_seconds % 3600) / 60 ))
    local seconds=$(( total_seconds % 60 ))

    if (( hours > 0 )); then
        echo "${hours}h ${minutes}m ${seconds}s"
    elif (( minutes > 0 )); then
        echo "${minutes}m ${seconds}s"
    else
        echo "${seconds}s"
    fi
}

shutdown() {
    local elapsed=$(( $(date +%s) - start ))
    printf '\x1B[2K\r'
    echo "Stopped at $(date)"
    echo "Total runtime  $(format_seconds "$elapsed")"
    exit 0
}

trap shutdown SIGINT SIGTERM SIGQUIT

start=$(date +%s)
echo "Stop with: Ctrl+c or \`kill $$\`"
echo "Started at $(date)"

while true; do
    elapsed=$(( $(date +%s) - start ))
    printf '\x1B[2K\rElapsed time: %s' "$(format_seconds "$elapsed")"
    sleep 0.3
done
